name: Build Windows (portable)

on:
  workflow_dispatch:
    inputs:
      channel:
        description: "Channel for core libs (prod/dev)"
        required: true
        default: "prod"
        type: choice
        options:
          - prod
          - dev
      build_target:
        description: "Dart entrypoint"
        required: true
        default: "lib/main_prod.dart"
        type: choice
        options:
          - lib/main_prod.dart
          - lib/main.dart

concurrency:
  group: windows-portable-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.3"
          channel: stable
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      - name: Generate code (build_runner)
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Generate translations (slang)
        run: dart run slang

      - name: Fetch Windows core libs
        run: make windows-libs CHANNEL=${{ inputs.channel }}

      - name: Build Windows (release)
        run: flutter build windows --release --target ${{ inputs.build_target }}

      - name: Package portable ZIP
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $src = "build/windows/x64/runner/Release"
          if (!(Test-Path $src)) { throw "Build output not found: $src" }
          New-Item -ItemType Directory -Force -Path "out" | Out-Null
          $zip = "out/GoBull-Windows-portable.zip"
          if (Test-Path $zip) { Remove-Item $zip -Force }
          Compress-Archive -Path "$src/*" -DestinationPath $zip
          Get-Item $zip | Format-List Name,Length,FullName

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-portable
          if-no-files-found: error
          path: out/*.zip



